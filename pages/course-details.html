---
# File: pages/course-details.html
# Purpose: Content page (course-details) rendered with the default layout.
# Related files:
#   - _layouts/default.html
#   - assets/css/styles.css
#   - assets/js/site.js
# Safe edits:
#   - OK: Edit content and explanatory text; adjust chart config carefully
#   - Careful: Avoid renaming ids used by inline scripts (charts/controls) unless you update the JS accordingly
layout: default
title: "ODS per assignatura"
lang: ca
---

<style>
.course-controls {
  display: block;
  margin: 0.55rem 0 0.8rem;
}

.course-card {
  background: var(--site-surface-2, #e8eff7);
  border: 1px solid var(--site-widget-border, #d8e1eb);
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(33, 52, 75, 0.1);
  padding: 14px 14px 12px;
}

.course-control-grid {
  display: grid;
  grid-template-columns: repeat(4, minmax(0, 1fr));
  gap: 10px 12px;
  align-items: end;
}

.course-control-item {
  min-width: 0;
}

.course-field-label {
  display: block;
  margin: 0 0 0.24rem;
  font-weight: 700;
  font-size: 0.95rem;
  line-height: 1.35;
  color: var(--site-text, #1f2a36);
}

.course-control-item .selector-container {
  margin: 0;
  gap: 8px;
}

.course-control-item .selector-box {
  width: 100%;
  max-width: none !important;
  margin: 0;
}

.course-control-item .w3-select {
  width: 100%;
  min-width: 0;
  background-color: #fff;
  color: #111;
  border: 1px solid #c4d0dc !important;
  border-radius: 6px;
  padding: 10px 36px 10px 12px;
  min-height: 42px;
  font-size: 1rem;
  line-height: 1.2;
  box-sizing: border-box;
}

.course-control-item .w3-select:focus {
  background-color: #f7fbff;
  border-color: var(--site-accent, #5f7898) !important;
  box-shadow: 0 0 0 2px rgba(95, 120, 152, 0.22);
}

.course-control-item .w3-select:disabled {
  background-color: #eef2f7;
  color: #7b8a9d;
}

#degree-info-container,
#courses-table-container {
  width: 100%;
}

#courses-table-container {
  overflow-x: auto;
}

.course-toggle-col {
  width: 64px;
  text-align: center;
}

.course-toggle-cell {
  text-align: center;
  vertical-align: middle;
}

.course-row-toggle {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid var(--site-accent-dark, #334457);
  background: var(--site-accent, #3f536b);
  color: #fff;
  cursor: pointer;
  transition: background-color 0.18s ease, transform 0.18s ease;
}

.course-row-toggle:hover,
.course-row-toggle:focus-visible {
  background: var(--site-accent-dark, #334457);
}

.course-row-toggle:focus-visible {
  outline: 2px solid rgba(63, 83, 107, 0.28);
  outline-offset: 2px;
}

.course-row-toggle-icon {
  font-size: 1.35rem;
  font-weight: 700;
  line-height: 1;
  transform: rotate(0deg);
  transition: transform 0.2s ease;
}

.course-row-toggle[aria-expanded="true"] .course-row-toggle-icon {
  transform: rotate(45deg);
}

@media (max-width: 768px) {
  .course-control-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<!-- Header -->
  <header class="w3-container" style="padding-top:22px">
  <h5><b><i class="fa fa-eye"></i> Una primera ullada &gt; ODS per assignatura</b></h5>
  </header>

  <!-- Main Content -->
  <div class="horizontal-container">
    <h1>ODS per assignatura</h1>
    <p>Aquesta pàgina mostra informació sobre les assignatures de l'ensenyament de la URV concret que vostè seleccioni
      i mostra la seva alineació amb els Objectius de Desenvolupament Sostenible.</p>
    <p>Els termes son dels conceptes detectats per un algoritme d'aprenentatge automàtic però, 
      no necessàriament apareixen explicitats a les guies docents.</p>

    <!-- Selectors (homogeneous with other visualizations) -->
    <div class="course-controls">
      <section class="course-card" aria-label="Filtres d'ODS per assignatura">
        <div class="course-control-grid">
          <div class="course-control-item">
            <label for="faculty-select" class="course-field-label">Centre</label>
            <div class="selector-container">
              <div class="selector-box">
                <select id="faculty-select" class="w3-select w3-border">
                  <option value="">-- Selecciona un centre --</option>
                </select>
              </div>
            </div>
          </div>

          <div class="course-control-item">
            <label for="degree-select" class="course-field-label">Ensenyament</label>
            <div class="selector-container">
              <div class="selector-box">
                <select id="degree-select" class="w3-select w3-border" disabled>
                  <option value="" selected disabled>Selecciona…</option>
                  <option value="ALL">Tots</option>
                </select>
              </div>
            </div>
          </div>

          <div class="course-control-item">
            <label for="course-system-select" class="course-field-label">Sistema de classificació</label>
            <div class="selector-container">
              <div class="selector-box">
                <select id="course-system-select" class="w3-select w3-border" disabled>
                  <option value="">Carregant sistemes...</option>
                </select>
              </div>
            </div>
          </div>

          <div class="course-control-item">
            <label for="course-section-select" class="course-field-label">Secció analitzada</label>
            <div class="selector-container">
              <div class="selector-box">
                <select id="course-section-select" class="w3-select w3-border" disabled>
                  <option value="">Carregant seccions...</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <p id="course-details-status" class="w3-small" hidden></p>

    <!-- Teaching Information -->
    <div id="degree-info-container" class="degree-info" style="display: none;">
      <h3 id="degree-title"></h3>
      <p><strong>Centre:</strong> <span id="degree-faculty"></span></p>
      <p><strong>Cursos acadèmics:</strong> <span id="academic-years"></span></p>
      <p><strong>Total d'assignatures:</strong> <span id="total-courses"></span></p>
      <p><strong>Assignatures amb ODS:</strong> <span id="sdg-courses"></span></p>
      <p><strong>Cobertura:</strong> <span id="sdg-ratio"></span></p>
      <p><strong>Anàlisi aplicada:</strong> <span id="analysis-summary"></span></p>
    </div>

    <!-- Courses Table -->
    <div id="courses-table-container" style="display: none; margin-top: 20px;">
      <h3>Llista d'assignatures de l'ensenyament</h3>
      <table class="courses-table">
        <thead>
          <tr>
            <th>Assignatura</th>
            <th>ODS identificats</th>
            <th>Crèdits</th>
            <th>Any acadèmic</th>
            <th>Quadrimestre</th>
            <th class="course-toggle-col">Detall</th>
          </tr>
        </thead>
        <tbody id="courses-table-body">
        </tbody>
      </table>
    </div>
  </div>

<script>
const sdgDefinitions = {
  "ODS-01": "Fi de la pobresa",
  "ODS-02": "Fam zero",
  "ODS-03": "Salut i benestar",
  "ODS-04": "Educació de qualitat",
  "ODS-05": "Igualtat de gènere",
  "ODS-06": "Aigua neta i sanejament",
  "ODS-07": "Energia neta i assequible",
  "ODS-08": "Treball digne i creixement econòmic",
  "ODS-09": "Indústria, innovació i infraestructura",
  "ODS-10": "Reducció de les desigualtats",
  "ODS-11": "Ciutats i comunitats sostenibles",
  "ODS-12": "Producció i consum responsables",
  "ODS-13": "Acció climàtica",
  "ODS-14": "Vida submarina",
  "ODS-15": "Vida d'ecosistemes terrestres",
  "ODS-16": "Pau, justícia i institucions sòlides",
  "ODS-17": "Aliança per assolir els objectius"
};

const sdgColors = {
  "ODS-01": "#e5243b",
  "ODS-02": "#dda63a",
  "ODS-03": "#4c9f38",
  "ODS-04": "#c5192d",
  "ODS-05": "#ff3a21",
  "ODS-06": "#26bde2",
  "ODS-07": "#fcc30b",
  "ODS-08": "#a21942",
  "ODS-09": "#fd6925",
  "ODS-10": "#dd1367",
  "ODS-11": "#fd9d24",
  "ODS-12": "#bf8b2e",
  "ODS-13": "#3f7e44",
  "ODS-14": "#0a97d9",
  "ODS-15": "#56c02b",
  "ODS-16": "#00689d",
  "ODS-17": "#19486a"
};

const SYSTEM_LABEL_OVERRIDES = {
  "sys:any": "Qualsevol sistema (Unió)",
  "sys:all": "Tots els sistemes (Intersecció)",
  "sys:auckland": "Auckland",
  "sys:aurora": "Aurora",
  "sys:elsevier": "Elsevier",
  "ens:equal": "Ensemble equal",
  "ens:third": "Ensemble third",
  "ens:triple": "Ensemble triple",
  "sys:sdgo": "SDGO",
  "sys:sdsn": "SDSN",
  "sys:siris": "SIRIS"
};

const SECTION_LABEL_OVERRIDES = {
  "sec:any": "Totes les seccions (Unió)",
  "sec:all": "Coincidència de totes les seccions (Intersecció)",
  "sec:competences": "Competències",
  "sec:course_info": "Informació de l'assignatura",
  "sec:references": "Referències"
};

const DEFAULT_SYSTEM_ID = "sys:any";
const DEFAULT_SECTION_ID = "sec:any";
const DEFAULT_FACULTY_NAME = "Facultat de Turisme i Geografia";
const API_BASE_CANDIDATES = Array.from(
  new Set(
    [
      "{{ site.sdgs_api_base_url | default: 'https://geourv.github.io/urv-sdgs-api' }}",
      "https://raw.githubusercontent.com/geourv/urv-sdgs-api/main"
    ]
      .map((value) => String(value || "").trim().replace(/\/+$/, ""))
      .filter(Boolean)
  )
);

const PERIOD_ORDER = {
  "Primer quadrimestre": 1,
  "Segon quadrimestre": 2,
  "Anual": 3
};

const facultySelect = document.getElementById("faculty-select");
const degreeSelect = document.getElementById("degree-select");
const systemSelect = document.getElementById("course-system-select");
const sectionSelect = document.getElementById("course-section-select");
const statusEl = document.getElementById("course-details-status");
const degreeInfoContainer = document.getElementById("degree-info-container");
const degreeTitleEl = document.getElementById("degree-title");
const degreeFacultyEl = document.getElementById("degree-faculty");
const academicYearsEl = document.getElementById("academic-years");
const totalCoursesEl = document.getElementById("total-courses");
const sdgCoursesEl = document.getElementById("sdg-courses");
const sdgRatioEl = document.getElementById("sdg-ratio");
const analysisSummaryEl = document.getElementById("analysis-summary");
const tableContainer = document.getElementById("courses-table-container");
const tableBody = document.getElementById("courses-table-body");

const state = {
  apiBase: "",
  apiVersion: "",
  centres: [],
  centreByCode: new Map(),
  programmesByCentreCode: new Map(),
  programmeByKey: new Map(),
  systemOptions: [],
  sectionOptions: [],
  programmeCache: new Map(),
  courseDetailCache: new Map(),
  renderToken: 0
};

function normalizeWhitespace(value) {
  return String(value || "").replace(/\s+/g, " ").trim();
}

function escapeHtml(value) {
  return String(value == null ? "" : value)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function normalizeSystemId(systemId) {
  if (systemId === "ens:equal") return "sys:ensemble_equal";
  if (systemId === "ens:third") return "sys:ensemble_third";
  if (systemId === "ens:triple") return "sys:ensemble_triple";
  return String(systemId || "");
}

function normalizeSdgCodeToOds(code) {
  return String(code || "").replace(/^SDG-/, "ODS-");
}

function programmeKey(centreCode, programmeCode) {
  return `${String(centreCode || "")}::${String(programmeCode || "")}`;
}

function addOption(selectEl, value, label) {
  const option = document.createElement("option");
  option.value = String(value || "");
  option.textContent = normalizeWhitespace(label);
  selectEl.appendChild(option);
}

function joinUrl(...parts) {
  return parts
    .filter((part) => part != null && String(part).trim() !== "")
    .map((part, index) => {
      const chunk = String(part).trim();
      if (index === 0) return chunk.replace(/\/+$/, "");
      return chunk.replace(/^\/+/, "");
    })
    .join("/");
}

async function fetchJson(url) {
  const response = await fetch(url, { cache: "no-cache" });
  if (!response.ok) throw new Error(`HTTP ${response.status} (${url})`);
  return response.json();
}

async function fetchApiJson(relativePath) {
  return fetchJson(joinUrl(state.apiBase, relativePath));
}

async function resolveApiBaseAndVersion() {
  let lastError = null;
  for (const base of API_BASE_CANDIDATES) {
    try {
      const versions = await fetchJson(joinUrl(base, "versions.json"));
      const latest = normalizeWhitespace(versions?.latest);
      if (!latest) throw new Error("versions.json sense camp latest");
      state.apiBase = base;
      state.apiVersion = latest;
      return;
    } catch (err) {
      lastError = err;
    }
  }
  throw lastError || new Error("No s'ha pogut resoldre l'API.");
}

function readSharedFilters() {
  const fallback = {
    centreCode: "",
    programmeKey: "",
    systemId: DEFAULT_SYSTEM_ID,
    sectionId: DEFAULT_SECTION_ID
  };
  const store = window.SDGFilterMemory;
  if (!store || typeof store.read !== "function") return fallback;
  const raw = store.read() || {};
  return {
    centreCode: String(raw.centreCode || ""),
    programmeKey: String(raw.programmeKey || ""),
    systemId: normalizeSystemId(String(raw.systemId || DEFAULT_SYSTEM_ID)) || DEFAULT_SYSTEM_ID,
    sectionId: String(raw.sectionId || DEFAULT_SECTION_ID) || DEFAULT_SECTION_ID
  };
}

function writeSharedFilters(patch) {
  const store = window.SDGFilterMemory;
  if (!store || typeof store.write !== "function") return null;
  const payload = { ...(patch || {}) };
  if (Object.prototype.hasOwnProperty.call(payload, "systemId")) {
    payload.systemId = normalizeSystemId(payload.systemId) || DEFAULT_SYSTEM_ID;
  }
  if (Object.prototype.hasOwnProperty.call(payload, "sectionId")) {
    payload.sectionId = String(payload.sectionId || DEFAULT_SECTION_ID) || DEFAULT_SECTION_ID;
  }
  return store.write(payload);
}

function setStatus(message, isError) {
  const normalized = normalizeWhitespace(message);
  statusEl.textContent = normalized;
  statusEl.hidden = normalized.length === 0;
  statusEl.style.color = (isError && normalized) ? "#c0392b" : "#4f5f70";
}

function setControlsEnabled(enabled) {
  facultySelect.disabled = !enabled;
  degreeSelect.disabled = !enabled || !facultySelect.value;
  systemSelect.disabled = !enabled;
  sectionSelect.disabled = !enabled;
}

function getSelectedCentreCode() {
  return String(facultySelect.value || "");
}

function getSelectedProgrammeKey() {
  return String(degreeSelect.value || "");
}

function getSelectedSystemId() {
  return normalizeSystemId(String(systemSelect.value || DEFAULT_SYSTEM_ID)) || DEFAULT_SYSTEM_ID;
}

function getSelectedSectionId() {
  return String(sectionSelect.value || DEFAULT_SECTION_ID) || DEFAULT_SECTION_ID;
}

function getSelectedOptionLabel(selectEl) {
  if (!selectEl || selectEl.selectedIndex < 0) return "";
  return normalizeWhitespace(selectEl.options[selectEl.selectedIndex]?.textContent || "");
}

function persistSharedFiltersFromControls() {
  writeSharedFilters({
    centreCode: getSelectedCentreCode(),
    programmeKey: getSelectedProgrammeKey(),
    systemId: getSelectedSystemId(),
    sectionId: getSelectedSectionId()
  });
}

async function loadIndexes() {
  const prefix = state.apiVersion;
  const [centres, programmes, systemsJson, sectionsJson] = await Promise.all([
    fetchApiJson(`${prefix}/index/centres.json`),
    fetchApiJson(`${prefix}/index/programmes.json`),
    fetchApiJson(`${prefix}/index/systems.json`),
    fetchApiJson(`${prefix}/index/sections.json`)
  ]);

  state.centres = (Array.isArray(centres) ? centres : [])
    .map((row) => ({
      centre_code: String(row?.centre_code || ""),
      centre_name: normalizeWhitespace(row?.centre_name),
      json: String(row?.json || "")
    }))
    .filter((row) => row.centre_code && row.centre_name)
    .sort((a, b) => a.centre_name.localeCompare(b.centre_name, "ca"));
  state.centreByCode = new Map(state.centres.map((row) => [row.centre_code, row]));

  state.programmesByCentreCode = new Map();
  state.programmeByKey = new Map();
  (Array.isArray(programmes) ? programmes : []).forEach((row) => {
    const programme = {
      centre_code: String(row?.centre_code || ""),
      programme_code: String(row?.programme_code || ""),
      programme_name: normalizeWhitespace(row?.programme_name),
      json: String(row?.json || "")
    };
    if (!programme.centre_code || !programme.programme_code || !programme.programme_name || !programme.json) return;

    const key = programmeKey(programme.centre_code, programme.programme_code);
    if (!state.programmesByCentreCode.has(programme.centre_code)) {
      state.programmesByCentreCode.set(programme.centre_code, []);
    }
    state.programmesByCentreCode.get(programme.centre_code).push(programme);
    state.programmeByKey.set(key, programme);
  });

  for (const [centreCode, items] of state.programmesByCentreCode.entries()) {
    items.sort((a, b) => a.programme_name.localeCompare(b.programme_name, "ca"));
    state.programmesByCentreCode.set(centreCode, items);
  }

  state.systemOptions = Array.isArray(systemsJson?.system_options) ? systemsJson.system_options : [];
  state.sectionOptions = Array.isArray(sectionsJson?.section_options) ? sectionsJson.section_options : [];
}

function populateFacultySelect(selectedCentreCode) {
  facultySelect.innerHTML = "";
  addOption(facultySelect, "", "-- Selecciona un centre --");
  state.centres.forEach((centre) => addOption(facultySelect, centre.centre_code, centre.centre_name));

  const selected = String(selectedCentreCode || "");
  facultySelect.value = state.centreByCode.has(selected) ? selected : "";
}

function populateDegreeSelect(centreCode, selectedProgrammeKey) {
  degreeSelect.innerHTML = "";

  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "Selecciona…";
  placeholder.disabled = true;
  degreeSelect.appendChild(placeholder);

  const allOption = document.createElement("option");
  allOption.value = "ALL";
  allOption.textContent = "Tots";
  degreeSelect.appendChild(allOption);

  const centreKey = String(centreCode || "");
  const programmes = state.programmesByCentreCode.get(centreKey) || [];
  const validProgrammeKeys = new Set();

  programmes.forEach((programme) => {
    const key = programmeKey(programme.centre_code, programme.programme_code);
    validProgrammeKeys.add(key);
    addOption(degreeSelect, key, programme.programme_name);
  });

  degreeSelect.disabled = !centreKey;
  if (!centreKey) {
    degreeSelect.value = "";
    return;
  }

  const selected = String(selectedProgrammeKey || "");
  if (selected === "ALL") {
    degreeSelect.value = "ALL";
  } else {
    degreeSelect.value = validProgrammeKeys.has(selected) ? selected : "";
  }
}

function populateSystemSelect(selectedSystemId) {
  systemSelect.innerHTML = "";
  state.systemOptions.forEach((row) => {
    const id = String(row?.id || "");
    const label = SYSTEM_LABEL_OVERRIDES[id] || normalizeWhitespace(row?.label || id);
    addOption(systemSelect, id, label);
  });

  const selected = normalizeSystemId(selectedSystemId);
  const resolvedOption = state.systemOptions.find((row) => {
    return normalizeSystemId(String(row?.id || "")) === selected;
  });
  const fallback = state.systemOptions[0] ? String(state.systemOptions[0].id || "") : "";
  systemSelect.value = resolvedOption ? String(resolvedOption?.id || "") : fallback;
}

function populateSectionSelect(selectedSectionId) {
  sectionSelect.innerHTML = "";
  state.sectionOptions.forEach((row) => {
    const id = String(row?.id || "");
    const label = SECTION_LABEL_OVERRIDES[id] || normalizeWhitespace(row?.label || id);
    addOption(sectionSelect, id, label);
  });

  const selected = String(selectedSectionId || "");
  const fallback = state.sectionOptions[0] ? String(state.sectionOptions[0].id || "") : "";
  const exists = state.sectionOptions.some((row) => String(row?.id || "") === selected);
  sectionSelect.value = exists ? selected : fallback;
}

async function getProgrammeDetail(programmeKeyValue) {
  const key = String(programmeKeyValue || "");
  if (!key) throw new Error("Ensenyament no seleccionat");
  if (state.programmeCache.has(key)) return state.programmeCache.get(key);

  const programme = state.programmeByKey.get(key);
  if (!programme?.json) throw new Error(`Ensenyament sense fitxer de detall: ${key}`);

  const detail = await fetchApiJson(`${state.apiVersion}/${programme.json}`);
  state.programmeCache.set(key, detail);
  return detail;
}

async function getCourseDetail(courseDetailPath) {
  const key = String(courseDetailPath || "");
  if (!key) throw new Error("Curs sense ruta de detall");
  if (state.courseDetailCache.has(key)) return state.courseDetailCache.get(key);

  const detail = await fetchApiJson(`${state.apiVersion}/${key}`);
  state.courseDetailCache.set(key, detail);
  return detail;
}

function normalizeSdgSelection(value) {
  const rawList = Array.isArray(value)
    ? value
    : (typeof value === "string" && value ? [value] : []);
  return Array.from(new Set(rawList
    .map((code) => normalizeSdgCodeToOds(code))
    .filter((code) => /^ODS-\d{2}$/.test(code))
  )).sort((a, b) => a.localeCompare(b, "ca"));
}

function extractCourseSdgs(course, systemId, sectionId) {
  const raw = course?.sdg_compact?.[String(systemId || "")]?.[String(sectionId || "")];
  return normalizeSdgSelection(raw);
}

function extractFeatureRows(courseDetail, systemId, sectionId) {
  const rows = courseDetail?.by_set?.feature?.[String(systemId || "")]?.[String(sectionId || "")];
  if (!Array.isArray(rows)) return [];
  return rows
    .map((row) => ({
      feature: normalizeWhitespace(row?.feature),
      n_hits: Number(row?.n_hits || 0)
    }))
    .filter((row) => row.feature && row.n_hits > 0)
    .sort((a, b) => b.n_hits - a.n_hits || a.feature.localeCompare(b.feature, "ca"));
}

function formatPercent(value) {
  const parsed = Number(value);
  if (!Number.isFinite(parsed)) return "0,0";
  return parsed.toLocaleString("ca-ES", {
    minimumFractionDigits: 1,
    maximumFractionDigits: 1
  });
}

function buildAcademicYearsLabel(courses) {
  const years = Array.from(new Set(
    (Array.isArray(courses) ? courses : [])
      .map((course) => normalizeWhitespace(course?.academic_year))
      .filter(Boolean)
  ));
  if (!years.length) return "No disponible";
  years.sort((a, b) => b.localeCompare(a, "ca"));
  return years.join(", ");
}

function resetUI(message) {
  degreeInfoContainer.style.display = "none";
  degreeTitleEl.textContent = "";
  degreeFacultyEl.textContent = "";
  academicYearsEl.textContent = "";
  totalCoursesEl.textContent = "";
  sdgCoursesEl.textContent = "";
  sdgRatioEl.textContent = "";
  analysisSummaryEl.textContent = "";

  tableContainer.style.display = "block";
  tableBody.innerHTML = `
    <tr>
      <td colspan="6" class="w3-center w3-padding">${escapeHtml(message)}</td>
    </tr>
  `;
}

function renderDegreeInfo(programmeDetail, courseRows) {
  const nCourses = courseRows.length;
  const nWithOds = courseRows.reduce((acc, course) => acc + (course.__ods.length > 0 ? 1 : 0), 0);
  const coveragePct = nCourses > 0 ? (nWithOds * 100) / nCourses : 0;

  degreeTitleEl.textContent = normalizeWhitespace(programmeDetail?.programme?.name || "Ensenyament");
  degreeFacultyEl.textContent = normalizeWhitespace(programmeDetail?.centre?.name || "-");
  academicYearsEl.textContent = buildAcademicYearsLabel(courseRows);
  totalCoursesEl.textContent = String(nCourses);
  sdgCoursesEl.textContent = `${nWithOds} de ${nCourses}`;
  sdgRatioEl.textContent = `${formatPercent(coveragePct)}%`;
  analysisSummaryEl.textContent = `${getSelectedOptionLabel(systemSelect)} · ${getSelectedOptionLabel(sectionSelect)}`;
  degreeInfoContainer.style.display = "block";
}

function getAcademicYearSortValue(value) {
  const text = String(value || "");
  const match = text.match(/(\d{4})/);
  return match ? Number(match[1]) : 0;
}

function createSdgSquares(odsCodes) {
  if (!Array.isArray(odsCodes) || !odsCodes.length) return "No té ODS associats";
  return odsCodes.map((ods) => {
    const title = `${ods}: ${sdgDefinitions[ods] || ods}`;
    const color = sdgColors[ods] || "#9aa7b5";
    return `<span class="course-sdg" title="${escapeHtml(title)}" style="background-color:${escapeHtml(color)};"></span>`;
  }).join("");
}

function createSdgLegendItems(odsCodes) {
  if (!Array.isArray(odsCodes) || !odsCodes.length) return "No té ODS associats.";
  return odsCodes.map((ods) => {
    const color = sdgColors[ods] || "#9aa7b5";
    const label = sdgDefinitions[ods] || ods;
    return `
      <div class="sdg-legend-item">
        <div class="sdg-color" style="background-color:${escapeHtml(color)};"></div>
        <span class="sdg-code">${escapeHtml(ods)}</span>
        <span class="sdg-name">${escapeHtml(label)}</span>
      </div>
    `;
  }).join("");
}

function createFeatureChips(features) {
  if (!Array.isArray(features) || !features.length) {
    return "No hi ha features detectades per aquest sistema i secció.";
  }
  return features.slice(0, 36).map((item) => {
    const name = escapeHtml(item.feature);
    const hits = Number(item.n_hits || 0);
    return `<span class="feature-item" title="${hits} deteccions">${name} (${hits})</span>`;
  }).join("");
}

function buildCourseDetailHtml(course, odsCodes, features, systemLabel, sectionLabel) {
  const courseName = escapeHtml(normalizeWhitespace(course?.course_name || "Assignatura"));
  const courseCode = escapeHtml(normalizeWhitespace(course?.course_code || "-"));
  const credits = escapeHtml(normalizeWhitespace(course?.course_credits || "-"));
  const courseType = escapeHtml(normalizeWhitespace(course?.course_type || "-"));
  const coursePeriod = escapeHtml(normalizeWhitespace(course?.course_period || "-"));
  const academicYear = escapeHtml(normalizeWhitespace(course?.academic_year || "-"));
  const sourceSystem = escapeHtml(normalizeWhitespace(course?.source_system || "-"));
  const courseUrl = normalizeWhitespace(course?.course_url);

  let html = `
    <div class="w3-container w3-padding">
      <h4>${courseName}</h4>
      <div class="w3-row">
        <div class="w3-col m6">
          <p><strong>Codi:</strong> ${courseCode}</p>
          <p><strong>Crèdits:</strong> ${credits}</p>
          <p><strong>Tipus:</strong> ${courseType}</p>
        </div>
        <div class="w3-col m6">
          <p><strong>Any acadèmic:</strong> ${academicYear}</p>
          <p><strong>Quadrimestre:</strong> ${coursePeriod}</p>
          <p><strong>Font docent:</strong> ${sourceSystem}</p>
        </div>
      </div>
  `;

  if (courseUrl) {
    html += `
      <p><strong>Guia docent:</strong>
      <a href="${escapeHtml(courseUrl)}" target="_blank" rel="noopener noreferrer">Veure document</a></p>
    `;
  }

  html += `
    <div class="w3-margin-top">
      <strong>ODS identificats (${escapeHtml(systemLabel)} · ${escapeHtml(sectionLabel)}):</strong>
      <div class="sdg-list">
        ${createSdgLegendItems(odsCodes)}
      </div>
    </div>

    <div class="w3-margin-top">
      <strong>Features detectades:</strong>
      <div class="feature-list">
        ${createFeatureChips(features)}
      </div>
    </div>
    </div>
  `;

  return html;
}

function syncCourseToggleButtonState(toggleBtn, isExpanded) {
  if (!toggleBtn) return;
  const expanded = Boolean(isExpanded);
  const label = expanded ? "Oculta el detall de l'assignatura" : "Mostra el detall de l'assignatura";
  toggleBtn.setAttribute("aria-expanded", String(expanded));
  toggleBtn.setAttribute("aria-label", label);
  toggleBtn.setAttribute("title", expanded ? "Oculta el detall" : "Mostra el detall");
}

async function toggleCourseDetails(detailsRow, detailsCell, course, analysisContext, toggleBtn) {
  const currentlyVisible = detailsRow.style.display !== "none";
  if (currentlyVisible) {
    detailsRow.style.display = "none";
    detailsCell.innerHTML = "";
    syncCourseToggleButtonState(toggleBtn, false);
    return;
  }

  detailsRow.style.display = "table-row";
  syncCourseToggleButtonState(toggleBtn, true);
  detailsCell.innerHTML = `
    <div class="w3-container w3-padding">
      <p>Carregant detall de l'assignatura...</p>
    </div>
  `;

  try {
    const courseDetail = await getCourseDetail(course.detail_json);
    const features = extractFeatureRows(courseDetail, analysisContext.systemId, analysisContext.sectionId);
    detailsCell.innerHTML = buildCourseDetailHtml(
      course,
      course.__ods,
      features,
      analysisContext.systemLabel,
      analysisContext.sectionLabel
    );
  } catch (err) {
    console.error(err);
    detailsCell.innerHTML = `
      <div class="w3-container w3-padding">
        <p><strong>No s'ha pogut carregar el detall del curs.</strong></p>
      </div>
    `;
  }
}

function showCoursesTable(courseRows, analysisContext) {
  tableBody.innerHTML = "";
  if (!Array.isArray(courseRows) || !courseRows.length) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="6" class="w3-center w3-padding">No hi ha assignatures disponibles per aquesta selecció.</td>
      </tr>
    `;
    tableContainer.style.display = "block";
    return;
  }

  const sorted = courseRows.slice().sort((a, b) => {
    const yearDiff = getAcademicYearSortValue(b?.academic_year) - getAcademicYearSortValue(a?.academic_year);
    if (yearDiff !== 0) return yearDiff;

    const aPeriod = PERIOD_ORDER[normalizeWhitespace(a?.course_period)] || 99;
    const bPeriod = PERIOD_ORDER[normalizeWhitespace(b?.course_period)] || 99;
    if (aPeriod !== bPeriod) return aPeriod - bPeriod;

    return normalizeWhitespace(a?.course_name).localeCompare(normalizeWhitespace(b?.course_name), "ca");
  });

  sorted.forEach((course) => {
    const row = document.createElement("tr");
    row.className = "course-row";

    const nameCell = document.createElement("td");
    nameCell.textContent = normalizeWhitespace(course?.course_name || "No disponible");

    const sdgsCell = document.createElement("td");
    sdgsCell.innerHTML = createSdgSquares(course.__ods);

    const creditsCell = document.createElement("td");
    creditsCell.textContent = normalizeWhitespace(course?.course_credits || "No disponible");

    const academicYearCell = document.createElement("td");
    academicYearCell.textContent = normalizeWhitespace(course?.academic_year || "No disponible");

    const periodCell = document.createElement("td");
    periodCell.textContent = normalizeWhitespace(course?.course_period || "No disponible");

    const toggleCell = document.createElement("td");
    toggleCell.className = "course-toggle-cell";
    const toggleBtn = document.createElement("button");
    toggleBtn.type = "button";
    toggleBtn.className = "course-row-toggle";
    toggleBtn.innerHTML = `<span class="course-row-toggle-icon" aria-hidden="true">+</span>`;
    syncCourseToggleButtonState(toggleBtn, false);
    toggleCell.appendChild(toggleBtn);

    row.appendChild(nameCell);
    row.appendChild(sdgsCell);
    row.appendChild(creditsCell);
    row.appendChild(academicYearCell);
    row.appendChild(periodCell);
    row.appendChild(toggleCell);
    tableBody.appendChild(row);

    const detailsRow = document.createElement("tr");
    detailsRow.className = "course-details-row";
    detailsRow.style.display = "none";

    const detailsCell = document.createElement("td");
    detailsCell.colSpan = 6;
    detailsCell.className = "course-details-cell";
    detailsRow.appendChild(detailsCell);
    tableBody.appendChild(detailsRow);

    toggleBtn.addEventListener("click", (event) => {
      event.stopPropagation();
      toggleCourseDetails(detailsRow, detailsCell, course, analysisContext, toggleBtn);
    });

    row.addEventListener("click", () => {
      toggleCourseDetails(detailsRow, detailsCell, course, analysisContext, toggleBtn);
    });
  });

  tableContainer.style.display = "block";
}

async function renderCurrentSelection() {
  const centreCode = getSelectedCentreCode();
  const programmeKeyValue = getSelectedProgrammeKey();

  if (!centreCode) {
    resetUI("Selecciona un centre i un ensenyament per veure el detall per assignatura.");
    setStatus("", false);
    return;
  }

  if (!programmeKeyValue || programmeKeyValue === "ALL") {
    resetUI("Selecciona un ensenyament per carregar la taula d'assignatures.");
    setStatus("", false);
    return;
  }

  const token = ++state.renderToken;
  setStatus("Carregant dades de l'ensenyament...");

  try {
    const programmeDetail = await getProgrammeDetail(programmeKeyValue);
    if (token !== state.renderToken) return;

    const systemId = getSelectedSystemId();
    const sectionId = getSelectedSectionId();
    const systemLabel = getSelectedOptionLabel(systemSelect);
    const sectionLabel = getSelectedOptionLabel(sectionSelect);

    const courses = Array.isArray(programmeDetail?.courses) ? programmeDetail.courses : [];
    const courseRows = courses.map((course) => ({
      ...course,
      __ods: extractCourseSdgs(course, systemId, sectionId)
    }));

    renderDegreeInfo(programmeDetail, courseRows);
    showCoursesTable(courseRows, {
      systemId,
      sectionId,
      systemLabel,
      sectionLabel
    });
    setStatus("", false);
  } catch (err) {
    console.error(err);
    resetUI("No s'han pogut carregar les assignatures d'aquest ensenyament.");
    setStatus("Error carregant dades des de l'API.", true);
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  setControlsEnabled(false);
  resetUI("Inicialitzant dades...");
  setStatus("Inicialitzant dades de l'API...");

  try {
    await resolveApiBaseAndVersion();
    await loadIndexes();

    const sharedFilters = readSharedFilters();
    const defaultCentre = state.centres.find((centre) => centre.centre_name === DEFAULT_FACULTY_NAME);
    const defaultCentreCode = defaultCentre?.centre_code || state.centres[0]?.centre_code || "";
    const initialCentreCode = state.centreByCode.has(sharedFilters.centreCode)
      ? sharedFilters.centreCode
      : defaultCentreCode;
    const initialProgramme = initialCentreCode ? sharedFilters.programmeKey : "";

    populateFacultySelect(initialCentreCode);
    populateDegreeSelect(initialCentreCode, initialProgramme);
    populateSystemSelect(sharedFilters.systemId);
    populateSectionSelect(sharedFilters.sectionId);
    persistSharedFiltersFromControls();

    setControlsEnabled(true);
    await renderCurrentSelection();
  } catch (err) {
    console.error(err);
    setControlsEnabled(false);
    resetUI("No s'ha pogut inicialitzar la càrrega de dades.");
    setStatus("Error inicialitzant l'API.", true);
  }

  facultySelect.addEventListener("change", async () => {
    populateDegreeSelect(getSelectedCentreCode(), "");
    persistSharedFiltersFromControls();
    await renderCurrentSelection();
  });

  degreeSelect.addEventListener("change", async () => {
    persistSharedFiltersFromControls();
    await renderCurrentSelection();
  });

  systemSelect.addEventListener("change", async () => {
    persistSharedFiltersFromControls();
    await renderCurrentSelection();
  });

  sectionSelect.addEventListener("change", async () => {
    persistSharedFiltersFromControls();
    await renderCurrentSelection();
  });
});
</script>
